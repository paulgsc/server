name: Publish Production Docker Images
on:
  workflow_dispatch:
  push:
    branches:
      - main
  release:
    types: [published]
concurrency: ${{ github.workflow }}-${{ github.ref }}
jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Get changed files
        id: changed-files
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }})
          elif [ "${{ github.event.before }}" == "0000000000000000000000000000000000000000" ]; then
            CHANGED_FILES=$(git diff --name-only origin/main...${{ github.sha }} 2>/dev/null || git ls-files)
          else
            CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
          fi

          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      - name: Compile Rust change detector
        run: |
          rustc .github/scripts/detect_crate_changes.rs -o detect_crate_changes
          chmod +x detect_crate_changes
      - name: Detect server changes
        id: server
        run: |
          OUTPUT=$(./detect_crate_changes \
            "apps/servers/file_host" \
            "apps/servers/file_host/Cargo.toml" \
            "infra/docker/Dockerfile.server" \
            "${{ steps.changed-files.outputs.files }}")
          echo "changed=$(echo "$OUTPUT" | grep "^changed=" | cut -d= -f2)" >> $GITHUB_OUTPUT
      - name: Detect obs changes
        id: obs
        run: |
          OUTPUT=$(./detect_crate_changes \
            "apps/some-obs" \
            "apps/some-obs/Cargo.toml" \
            "infra/docker/Dockerfile.obs" \
            "${{ steps.changed-files.outputs.files }}")
          echo "changed=$(echo "$OUTPUT" | grep "^changed=" | cut -d= -f2)" >> $GITHUB_OUTPUT
      - name: Detect orchestrator changes
        id: orchestrator
        run: |
          OUTPUT=$(./detect_crate_changes \
            "apps/orchestrator" \
            "apps/orchestrator/Cargo.toml" \
            "infra/docker/Dockerfile.orchestrator" \
            "${{ steps.changed-files.outputs.files }}")
          echo "changed=$(echo "$OUTPUT" | grep "^changed=" | cut -d= -f2)" >> $GITHUB_OUTPUT
      - name: Set Matrix
        id: set-matrix
        run: |
          SERVER='{"name":"file_host","dockerfile":"./infra/docker/Dockerfile.server","repo_suffix":"server"}'
          OBS='{"name":"some-obs","dockerfile":"./infra/docker/Dockerfile.obs","repo_suffix":"obs"}'
          ORCHESTRATOR='{"name":"orchestrator","dockerfile":"./infra/docker/Dockerfile.orchestrator","repo_suffix":"orchestrator"}'

          FORCE="${{ github.event_name == 'workflow_dispatch' || github.event_name == 'release' }}"

          JSON="["
          if [ "$FORCE" == "true" ] || [ "${{ steps.server.outputs.changed }}" == "true" ]; then JSON+="$SERVER,"; fi
          if [ "$FORCE" == "true" ] || [ "${{ steps.obs.outputs.changed }}" == "true" ]; then JSON+="$OBS,"; fi
          if [ "$FORCE" == "true" ] || [ "${{ steps.orchestrator.outputs.changed }}" == "true" ]; then JSON+="$ORCHESTRATOR,"; fi

          JSON=$(echo "$JSON" | sed 's/,$//')
          JSON+="]"

          echo "matrix=$JSON" >> $GITHUB_OUTPUT
  publish-docker:
    name: Build & Push ${{ matrix.image.name }}
    needs: detect-changes
    if: needs.detect-changes.outputs.matrix != '[]'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        image: ${{ fromJSON(needs.detect-changes.outputs.matrix) }}
    env:
      IMAGE_NAME: self-hosting-maishatu-${{ matrix.image.repo_suffix }}
      DOCKER_REPO: pgathondu/self-hosting-maishatu-${{ matrix.image.repo_suffix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.DOCKER_REPO }}
            ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
            type=semver,pattern={{version}}
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ matrix.image.dockerfile }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ matrix.image.name }}
          cache-to: type=gha,mode=max,scope=${{ matrix.image.name }}
          platforms: linux/amd64,linux/arm64
      - name: Build Summary
        run: |
          echo "### âœ… ${{ matrix.image.name }} Published" >> $GITHUB_STEP_SUMMARY
